# Thermostat (ESPHome / ESP32-C3)

Конфигурация термостата для ESP32-C3 с:
- 2 нагревателями через реле;
- вентилятором для выравнивания температуры;
- 4 температурными датчиками (1 внешний, 2 основной процессный, 3/4 по объёму);
- каскадным ПИД-регулятором (внешний контур формирует уставку, внутренний контур реализован через `- platform: thermostat`);
- аварийным звуковым сигнализатором;
- резервным управлением при отказе второго датчика;
- логикой включения второго нагревателя по динамике нагрева (dT/dt).

## Файл конфигурации

- `esphome/thermostat_esp32c3.yaml`

## Логика работы

1. **Каскадный ПИД**
   - Внешний контур: регулирует по `Sensor 1 External` относительно `Target External Temperature`.
   - Внутренний контур: `climate` на `- platform: thermostat` регулирует процессную температуру по выбранному датчику (основной `Sensor 2` или резервная средняя `Sensor 3/4`).

2. **Нагреватели**
   - `Heater 1 Relay`: основной, управляется `climate` (`platform: thermostat`).
   - `Heater 2 Relay`: резервный/добавочный, включается при высокой потребности в нагреве и низкой скорости роста температуры (`dT/dt`).

3. **Вентилятор**
   - Включается по разнице температур `|Sensor3 - Sensor4|` для выравнивания температуры по объёму.

4. **Аварийная сигнализация**
   - При отказе `Sensor 2` система переключается на резервный расчёт процессной температуры (среднее `Sensor 3/4`) и **продолжает работу без отключения термостата**.
   - При перегреве `Max Process Temperature` нагреватели отключаются до нормализации температуры.
   - Звуковой сигнализатор включается при перегреве `Max Process Temperature`, при неисправности `Sensor 2`, а также при критической (неисправимой) ситуации отказа основного и резервных датчиков.

## Важно перед прошивкой

- Замените адреса DS18B20 (`address`) на реальные адреса ваших датчиков.
- Проверьте соответствие GPIO пинов вашей плате/обвязке.
- Заполните `secrets.yaml` (`wifi_ssid`, `wifi_password`).

## Запуск проверки конфигурации

```bash
esphome config esphome/thermostat_esp32c3.yaml
```
